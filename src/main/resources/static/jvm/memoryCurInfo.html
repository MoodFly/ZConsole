<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zconsole-内存池</title>
<!--  <meta http-equiv="refresh" content="60" /> -->
<!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
<link rel="stylesheet" href="../static/bootstrap/css/bootstrap.min.css" />
<style type="text/css">
	.memoryChart{
		margin-bottom:30px;
		max-width:950px;
		min-width:650px;
		height:400px;
		display:inline-block;
	}
</style>
</head>
<body>
	<div class="container" style="width:100%">
		<div class="row">
		指标刷新间隔：<input type="text" maxlength=3 id="interval" value=3 style="width:30px;"/>秒
		<div>
			<table  class="table table-striped  table-hover" id="memoryInfoTable" style="width:500px;">
				<tr>
					<td></td><td>used</td><td>commit</td><td>max</td><td>init</td>
				</tr>
			</table>
			<div>heapMemory = oldGen + edenSpace + survivorSpace</div>
			<div>nonHeapMemory = metaspace + compressedClassSpace + codecache</div>
			<div>线程占用操作系统内存大小 =线程数*线程栈大小  ；</div>
			<div>还有直接内存的占用的操作系统内存大小</div>
			<div>以上加起来就是jvm进程占用的内存大小</div>
		</div>
		</div>
		<div class="row">
			<div id = "charts" class="col-xs-12 col-md-12">
			</div>
		</div>
		<footer class="footer navbar-fixed-bottom ">
    		<div class="container">
    		<div style="text-align:center;font-size:14px;"> ZConsole <a href="https://github.com/zhuqingzhen/ZConsole">github 开源地址 </a> ©2018 Zhuqz</div> 
   			</div>
		</footer>
	</div>

	<script src="../static/js/jquery-3.2.1.js"></script>
	<script src="../static/js/highcharts.js"></script>
	<script src="../static/js/util.js" type="text/javascript"></script>
	<script type="text/javascript">
		var jvmId = gerUrlParam("id");
		var curInterval = 3;
		var re = /^[0-9]+$/ ;
		$("#interval").blur(function(){
			var thisval = $(this).val();
			if(re.test(thisval)){
				if(thisval>0 && thisval<=60){
					curInterval = thisval;
					alert("当前指标刷新间隔为"+thisval+"秒")
					return;
				}else{
					 $(this).val(curInterval);
				}
			}else{
				$(this).val(curInterval);
			}
			alert("请输入大于0小于等于60的值");
		})
		$(document).ready(
				function() {
					Highcharts.setOptions({
						global : {
							useUTC : false
						}
					});

					var option = {
						chart : {
							zoomType : 'x',
							renderTo : 'container',
							type : 'spline',
							animation : Highcharts.svg,
							marginRight : 10,
							events : {
								load : function() {
								}
							}
						},
						title : {
							text : '',
							margin:60,
							align:"right",
							style: { "color": "#000", "fontSize": "20px",'fontWeight': 'bold' }
						},
						xAxis : {
							type : 'datetime',
							tickPixelInterval : 60,
							minRange:360000
						},
						yAxis : [ {
							title : {
								text : null
							//'max'
							},
							plotLines : [ {
								value : 0,
								width : 1,
								color : '#808080'
							} ]
						}, {
							title : {
								text : null
							//'init'
							},
							plotLines : [ {
								value : 0,
								width : 1,
								color : '#808080'
							} ]
						}, {
							title : {
								text : null
							//'commit'
							},
							plotLines : [ {
								value : 0,
								width : 1,
								color : '#808080'
							} ]
						}, {
							title : {
								text : null
							//'used'
							},
							plotLines : [ {
								value : 0,
								width : 1,
								color : '#808080'
							} ]
						} ],
						tooltip : {
							formatter : function() {
								return '<b>'
										+ this.series.name
										+ '</b><br/>'
										+ Highcharts.dateFormat(
												'%Y-%m-%d %H:%M:%S', this.x)
										+ '<br/>'
										+ Highcharts.numberFormat(this.y/1024/1024, 2)+"M";
							}
						},
						legend : {
							align : 'top',
							layout : 'horizontal',
							verticalAlign : 'top',
							y : 0,
							floating : false,
							borderWidth : 0
						},
						exporting : {
							enabled : false
						},
						series : [
								{
									name : 'max',
									data : (function() { // generate an array of random data                             
										var data = [], time = (new Date())
												.getTime(), i;
										for (i = -360; i <= 0; i++) {
											data.push({
												x : time + i * 1000,
												y : 0
											});
										}
										return data;
									})()
								},
								{
									name : 'init',
									data : (function() { // generate an array of random data                             
										var data = [], time = (new Date())
												.getTime(), i;
										for (i = -360; i <= 0; i++) {
											data.push({
												x : time + i * 1000,
												y : 0
											});
										}
										return data;
									})()
								},
								{
									name : 'commit',
									data : (function() { // generate an array of random data                             
										var data = [], time = (new Date())
												.getTime(), i;
										for (i = -360; i <= 0; i++) {
											data.push({
												x : time + i * 1000,
												y : 0
											});
										}
										return data;
									})()
								},
								{
									name : 'used',
									data : (function() { // generate an array of random data                             
										var data = [], time = (new Date())
												.getTime(), i;
										for (i = -360; i <= 0; i++) {
											data.push({
												x : time + i * 1000,
												y : 0
											});
										}
										return data;
									})()
								} ]
					};
					
					function initChart(){
						$.post("/memory/chart/curInfo.json", {
							"jvmId" : jvmId
						}, function(result) {
							if (result.code == 1 && result.data != null) {
								var data = result.data
								createChart(data);
								var getGcInfo = setTimeout(function() {
									var arg = arguments.callee;
									$.post("/memory/chart/curInfo.json", {
										"jvmId" : jvmId
									}, function(result) {
										if (result.code == 1 && result.data != null) {
											showChartData(result.data);
										}
										getGcInfo = setTimeout(arg, curInterval*1000);
									});
								}, curInterval*1000);
								
							}else{
								initChart();
							}
						});
					}
					initChart()
					var charts={};
					
					
					function createChart(data){
						var memoryInfoTable = $("#memoryInfoTable");
						for(var item in data){
							if(data[item]!=null){
								memoryInfoTable.append(
								   $("<tr>").append(
										$("<td>").append(item)
									).append(
										$("<td>",{"id":item+"Used"})
									).append(
										$("<td>",{"id":item+"Commit"})
									).append(
										$("<td>",{"id":item+"Max"})
									).append(
										$("<td>",{"id":item+"Init"})
									)
								);
								$("#charts").append($("<div>",{"id":item,"class":"memoryChart"}))
								option.title.text = item;
								option.chart.renderTo = item;
								charts[item] = new Highcharts.Chart(option);
							}
						}
					}
					
					function showChartData(data){
						var x = (new Date()).getTime();
						for(var item in data){
							if(data[item]!=null){
								$("#"+item+"Commit").empty().append(bytesToSize(data[item].committed));
								$("#"+item+"Used").empty().append(bytesToSize(data[item].used));
								$("#"+item+"Max").empty().append(bytesToSize(data[item].max));
								$("#"+item+"Init").empty().append(bytesToSize(data[item].init));
								charts[item].series[0].addPoint([x,data[item].max],true,true);
								charts[item].series[1].addPoint([x,data[item].init],true,true);
								charts[item].series[2].addPoint([x,data[item].committed],true,true);
								charts[item].series[3].addPoint([x,data[item].used],true,true);
							}
						}
					}
					
				});
		
		//监控gc
	</script>
</body>
</html>